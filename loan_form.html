<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loan Data Update </title>
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --accent-color: #4cc9f0;
            --success-color: #4caf50;
            --success-hover: #45a049;
            --light-bg: #f8f9fa;
            --dark-text: #212529;
            --light-text: #6c757d;
            --border-color: #dee2e6;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--dark-text);
        }

        .form-container {
            max-width: 700px;
            margin: 40px auto;
            background: white;
            border-radius: 16px;
            box-shadow: var(--shadow);
            overflow: hidden;
            transition: var(--transition);
        }

        .form-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .form-header h1 {
            font-weight: 600;
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .form-header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .form-body {
            padding: 30px;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-col {
            flex: 1;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-text);
            font-size: 1rem;
        }

        .required::after {
            content: " *";
            color: #e63946;
        }

        input, select {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 16px;
            transition: var(--transition);
            background-color: #fff;
        }

        input:focus, select:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }

        .readonly {
            background-color: var(--light-bg);
            color: var(--light-text);
        }

        button {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 16px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            width: 100%;
            transition: var(--transition);
            box-shadow: var(--shadow);
            letter-spacing: 0.5px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        button:active {
            transform: translateY(0);
        }

        .error {
            color: #e63946;
            font-size: 14px;
            margin-top: 8px;
            font-weight: 500;
        }

        .form-footer {
            text-align: center;
            padding: 20px;
            color: var(--light-text);
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .form-container {
                margin: 20px;
            }
            
            .form-body {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="form-container">
        <div class="form-header">
            <h1>Loan Data Update</h1>
            <p>Please fill in all required fields to update loan information</p>
            <div id="bankInfo" style="margin-top: 10px; font-size: 0.9rem; background: rgba(255,255,255,0.2); padding: 10px; border-radius: 5px; display: none;">
                <strong>Bank:</strong> <span id="currentBank"></span> | 
                <strong>User:</strong> <span id="currentUser"></span> | 
                <strong>Division:</strong> <span id="currentDivision"></span>
            </div>
        </div>
        
        <div class="form-body">
            <form id="loanForm">
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="beneficiaryName" class="required">Beneficiary Name</label>
                            <input type="text" id="beneficiaryName" name="beneficiaryName" required>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="beneficiaryNIC" class="required">Beneficiary NIC</label>
                            <input type="text" id="beneficiaryNIC" name="beneficiaryNIC" required>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="beneficiaryAddress" class="required">Beneficiary Address</label>
                    <input type="text" id="beneficiaryAddress" name="beneficiaryAddress" required>
                </div>

                <div class="form-group">
                    <label for="beneficiaryGNDivision" class="required">Beneficiary GN Division</label>
                    <select id="beneficiaryGNDivision" name="beneficiaryGNDivision" required>
                        <option value="">Select GN Division</option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="beneficiaryCategory" class="required">Beneficiary Category</label>
                            <select id="beneficiaryCategory" name="beneficiaryCategory" required>
                                <option value="">Select Category</option>
                                <option value="extremelyPoor">Aswesuma - Extremely poor</option>
                                <option value="transitional">Aswesuma - Transitional</option>
                                <option value="samurdhi">Samurdhi</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="interestRate" class="required">Interest Rate</label>
                            <input type="text" id="interestRate" name="interestRate" class="readonly" readonly>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="loanType" class="required">Loan Type</label>
                    <select id="loanType" name="loanType" required>
                        <option value="">Select Loan Type</option>
                        <option value="empowerment">Empowerment Loans</option>
                        <option value="ranpatha">Ranpatha Loans</option>
                    </select>
                    <div id="loanTypeError" class="error"></div>
                </div>

                <div class="form-group">
                    <label for="project" class="required">Project</label>
                    <select id="project" name="project" required>
                        <option value="">Select Project</option>
                        <option value="agricultural">Self Employment - Agricultural</option>
                        <option value="industrial">Self Employment - Industrial</option>
                        <option value="trade">Self Employment - Trade</option>
                        <option value="services">Self Employment - Services</option>
                        <option value="vocational">Vocational Training Fees</option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="loanAmount" class="required">Loan Amount</label>
                            <input type="number" id="loanAmount" name="loanAmount" min="0" required>
                            <div id="loanAmountError" class="error"></div>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="loanIssuedDate" class="required">Loan Issued Date</label>
                            <input type="date" id="loanIssuedDate" name="loanIssuedDate" required>
                        </div>
                    </div>
                </div>

                <button type="submit">Save Loan Data</button>
            </form>
        </div>
        
        <div class="form-footer">
            <p>Â© 2023 Loan Management System | Secure Data Entry</p>
        </div>
    </div>

    <script>
        // Check if user is logged in
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        if (!currentUser) {
            window.location.href = 'login.html';
        }

        // Define interest rates and maximum loan limits
        const categoryDetails = {
            'extremelyPoor': { rate: '8%', maxLoan: 100000 },
            'transitional': { rate: '9%', maxLoan: 250000 },
            'samurdhi': { rate: '4%', maxLoan: 500000 }
        };

        // Define loan types
        const loanTypes = [
            { id: 'empowerment', name: 'Empowerment Loans' },
            { id: 'ranpatha', name: 'Ranpatha Loans' }
        ];

        // Sample GN divisions for demonstration
        const gnDivisions = [
            'Colombo 01', 'Colombo 02', 'Colombo 03', 'Colombo 04', 'Colombo 05',
            'Gampaha 01', 'Gampaha 02', 'Gampaha 03', 'Negombo 01', 'Negombo 02'
        ];

        // Get DOM elements
        const beneficiaryCategory = document.getElementById('beneficiaryCategory');
        const loanType = document.getElementById('loanType');
        const interestRate = document.getElementById('interestRate');
        const loanAmount = document.getElementById('loanAmount');
        const loanAmountError = document.getElementById('loanAmountError');
        const loanTypeError = document.getElementById('loanTypeError');
        const beneficiaryGNDivision = document.getElementById('beneficiaryGNDivision');
        const bankInfo = document.getElementById('bankInfo');
        const currentBank = document.getElementById('currentBank');
        const currentUserElement = document.getElementById('currentUser');
        const currentDivision = document.getElementById('currentDivision');

        // Show bank info
        bankInfo.style.display = 'block';
        currentBank.textContent = currentUser.bank || 'Bank Name';
        currentUserElement.textContent = currentUser.username || 'User Name';
        currentDivision.textContent = currentUser.division || 'Division';

        // Populate GN divisions from divisions.json
        function populateGNDivisions() {
            fetch('divisions.json')
                .then(response => response.json())
                .then(data => {
                    // Filter divisions for current user's division
                    const userDivision = currentUser.division || 'Negombo'; // Default to Negombo if not set
                    const filteredDivisions = data.filter(item => item.division === userDivision);
                    
                    // Clear existing options
                    beneficiaryGNDivision.innerHTML = '<option value="">Select GN Division</option>';
                    
                    // Populate with GN divisions for user's division
                    filteredDivisions.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.gn_division;
                        option.textContent = item.gn_division;
                        beneficiaryGNDivision.appendChild(option);
                    });
                    
                    // If no divisions found for user's division, show all
                    if (filteredDivisions.length === 0) {
                        const allDivisions = [...new Set(data.map(item => item.gn_division))];
                        allDivisions.forEach(gnDiv => {
                            const option = document.createElement('option');
                            option.value = gnDiv;
                            option.textContent = gnDiv;
                            beneficiaryGNDivision.appendChild(option);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading divisions:', error);
                    // Fallback to sample divisions
                    beneficiaryGNDivision.innerHTML = '<option value="">Select GN Division</option>';
                    gnDivisions.forEach(gnDiv => {
                        const option = document.createElement('option');
                        option.value = gnDiv;
                        option.textContent = gnDiv;
                        beneficiaryGNDivision.appendChild(option);
                    });
                });
        }

        // Initialize GN divisions
        populateGNDivisions();

        // Event listener for beneficiary category change
        beneficiaryCategory.addEventListener('change', function() {
            const category = this.value;
            
            if (category && categoryDetails[category]) {
                // Set interest rate
                interestRate.value = categoryDetails[category].rate;
                
                // Set maximum loan amount validation
                loanAmount.max = categoryDetails[category].maxLoan;
                
                // Handle loan type restrictions
                if (category !== 'samurdhi') {
                    // Disable Ranpatha Loans for non-Samurdhi beneficiaries
                    const ranpathaOption = loanType.querySelector('option[value="ranpatha"]');
                    if (ranpathaOption) {
                        ranpathaOption.disabled = true;
                    }
                    
                    // If Ranpatha was selected, reset selection
                    if (loanType.value === 'ranpatha') {
                        loanType.value = '';
                        loanTypeError.textContent = 'Ranpatha Loans are only available for Samurdhi beneficiaries.';
                    }
                } else {
                    // Enable Ranpatha Loans for Samurdhi beneficiaries
                    const ranpathaOption = loanType.querySelector('option[value="ranpatha"]');
                    if (ranpathaOption) {
                        ranpathaOption.disabled = false;
                    }
                    loanTypeError.textContent = '';
                }
            } else {
                interestRate.value = '';
                loanAmount.max = '';
                
                // Re-enable all loan types when no category is selected
                const ranpathaOption = loanType.querySelector('option[value="ranpatha"]');
                if (ranpathaOption) {
                    ranpathaOption.disabled = false;
                }
                loanTypeError.textContent = '';
            }
            
            // Clear any previous error messages
            loanAmountError.textContent = '';
        });

        // Event listener for loan type change
        loanType.addEventListener('change', function() {
            const category = beneficiaryCategory.value;
            const selectedLoanType = this.value;
            
            // Check if trying to select Ranpatha without being Samurdhi
            if (selectedLoanType === 'ranpatha' && category && category !== 'samurdhi') {
                this.value = '';
                loanTypeError.textContent = 'Ranpatha Loans are only available for Samurdhi beneficiaries.';
            } else {
                loanTypeError.textContent = '';
            }
        });

        // Event listener for loan amount validation
        loanAmount.addEventListener('input', function() {
            const category = beneficiaryCategory.value;
            
            if (category && categoryDetails[category]) {
                const maxLoan = categoryDetails[category].maxLoan;
                const amount = parseFloat(this.value);
                
                if (amount > maxLoan) {
                    loanAmountError.textContent = `Maximum loan amount for this category is ${maxLoan.toLocaleString()}`;
                } else {
                    loanAmountError.textContent = '';
                }
            }
        });

        // Form submission handler
        document.getElementById('loanForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Validate form
            const category = beneficiaryCategory.value;
            const selectedLoanType = loanType.value;
            const amount = parseFloat(loanAmount.value);
            
            // Check if loan type is selected
            if (!selectedLoanType) {
                alert('Please select a loan type.');
                return;
            }
            
            // Check loan type restrictions
            if (selectedLoanType === 'ranpatha' && category !== 'samurdhi') {
                alert('Ranpatha Loans are only available for Samurdhi beneficiaries. Please select a different loan type or change the beneficiary category.');
                return;
            }
            
            // Check loan amount
            if (category && categoryDetails[category] && amount > categoryDetails[category].maxLoan) {
                alert('Please correct the loan amount before submitting.');
                return;
            }
            
            // Collect form data
            const formData = new FormData(this);
            const jsonData = {};
            for (const [key, value] of formData.entries()) {
                jsonData[key] = value;
            }
            
            // Add entry timestamp
            jsonData.entry_timestamp = new Date().toISOString().split('T')[0];
            
            // Fetch existing loan data
            fetch('loans.json')
                .then(response => response.json())
                .then(loanData => {
                    // Add new loan data
                    loanData.push(jsonData);
                    
                    // In a static environment, we can't actually save to a file
                    // So we'll save to localStorage as a fallback
                    localStorage.setItem('loanData', JSON.stringify(loanData));
                    
                    alert('Form submitted successfully!\\n\\nNote: In this static version, data is saved to your browser\'s storage. In a server environment, it would be saved to loans.json.');
                    // Reset form
                    this.reset();
                    // Reset interest rate field
                    interestRate.value = '';
                    // Clear error messages
                    loanAmountError.textContent = '';
                    loanTypeError.textContent = '';
                })
                .catch(error => {
                    console.error('Error saving loan data:', error);
                    alert('Error saving loan data. Please try again.');
                });
        });
    </script>
</body>
</html>